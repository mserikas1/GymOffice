@page "/receptionist"
@attribute [Authorize(Roles = "Receptionist")]

@if (ErrorMessage != null)
{
    <ErrorDisplay ErrorMessage="@ErrorMessage" ResetError="HandleResetError" />
}
else if (coachesTable == null || visitorsTable == null)
{
    <MudText Typo="Typo.h6" Class="pa-5">Loading data...</MudText>
    <DisplaySpinner />
}
else
{
<MudContainer Class="mt-4">
    <MudText Align="Align.Center">Receptionist's Work Place shows lists of visitors in gym and coaches at work and allows to check them in and register new visitors.</MudText>
    <MudGrid Class="mt-0">
        <!-- Visitors list -->
        <MudItem xs="12" sm="6">
            <MudCard Elevation="0" Class="rounded-lg pb-2">
                <MudCardActions Class="d-flex justify-center">
                    <!-- Opening Visitors Not In Gym list with checkin possibility -->
                    <MudButton Variant="Variant.Filled" Class="md-3 mr-3" Color="Color.Primary" Size="Size.Medium" Style="width:40%;"
                        OnClick="CheckVisitorInClick">Check Visitor In</MudButton> 
                    <!-- Going to a visitor registration form -->
                        <MudButton Variant="Variant.Filled" Class="md-3" Color="Color.Primary" Size="Size.Medium" Style="width:40%;" 
                        OnClick="RegisterNewVisitorClick">New Visitor...</MudButton>
                </MudCardActions>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Align="Align.Center">Visitors In Gym</MudText>
                        <MudTextField T="string" ValueChanged="@(str=>OnVisitorSearch(str))" Placeholder="Search a visitor" Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudTable Ref="@visitorsTable" Items="@Visitors" Hover="true" Dense="true" Striped="true" RowsPerPage="8"
                            OnRowClick="VisitorRowClickEvent" T="Visitor">
                        <HeaderContent>
                            <MudTh>First Name</MudTh>
                            <MudTh><MudTableSortLabel SortLabel="ln_sort" T="Visitor" InitialDirection="SortDirection.Ascending" 
                                SortBy="new Func<Visitor, object>(x=>x.LastName!)">Last Name</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="ph_sort" T="Visitor" 
                                SortBy="new Func<Visitor, object>(x=>x.PhoneNumber!)">Phone Number</MudTableSortLabel></MudTh>
                            <MudTh>View</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="First Name">@context.FirstName</MudTd>
                            <MudTd DataLabel="Last Name">@context.LastName</MudTd>
                            <MudTd DataLabel="Phone Number" HideSmall="true">@context.PhoneNumber</MudTd>
                            <MudTd><MudIconButton Icon="@Icons.Material.Filled.Preview" Variant="Variant.Filled" Color="Color.Default"
                                    Size="Size.Small" OnClick="(() => OpenVisitorView(context))" />
                            </MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText>No matching records found</MudText>
                        </NoRecordsContent>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{8, 15, 30, 50}" InfoFormat="@infoFormat" HorizontalAlignment="HorizontalAlignment.Center" />
                        </PagerContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <!-- Coaches list -->
        <MudItem xs="12" sm="6">
                <MudCard Elevation="0" Class="rounded-lg pb-2">
                <MudCardActions Class="d-flex justify-center">
                    <!-- Opening Coaches Not At Work list with checkin possibility -->
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Medium" Style="width:40%;" 
                        OnClick="CheckCoachInClick">Check Coach In</MudButton>
                </MudCardActions>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6" Align="Align.Center">Coaches At Work</MudText>
                        <MudTextField T="string" ValueChanged="@(str=>OnCoachSearch(str))" Placeholder="Search a coach" Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                        <MudTable Ref="@coachesTable" Items="@Coaches" Hover="true" Dense="true" Striped="true" RowsPerPage="8"
                            OnRowClick="CoachRowClickEvent" T="Coach">
                        <HeaderContent>
                                <MudTh>First Name</MudTh>
                                <MudTh><MudTableSortLabel SortLabel="ln_sort" T="Coach" InitialDirection="SortDirection.Ascending" 
                                SortBy="new Func<Coach, object>(x=>x.LastName)">Last Name</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="ph_sort" T="Coach" 
                                SortBy="new Func<Coach, object>(x=>x.PhoneNumber)">Phone Number</MudTableSortLabel></MudTh>
                            <MudTh>View</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="First Name">@context.FirstName</MudTd>
                            <MudTd DataLabel="Last Name">@context.LastName</MudTd>
                            <MudTd DataLabel="Phone Number" HideSmall="true">@context.PhoneNumber</MudTd>
                               <MudTd><MudIconButton Icon="@Icons.Material.Filled.Preview" Variant="Variant.Filled" Color="Color.Default"
                                    Size="Size.Small" OnClick="(() => OpenCoachView(context))" />
                            </MudTd>
                         </RowTemplate>
                        <NoRecordsContent>
                            <MudText>No matching records found</MudText>
                        </NoRecordsContent>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[]{8, 15, 30, 50}" InfoFormat="@infoFormat" HorizontalAlignment="HorizontalAlignment.Center" />
                        </PagerContent>
                    </MudTable>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
}

@code {
    [Inject] public IVisitorRepository VisitorRepository { get; set; } = null!;
    [Inject] public IEmployeeRepository EmployeeRepository { get; set; } = null!;
    [Inject] public ICoachRepository CoachRepository { get; set; } = null!;
    [Inject] public IDialogService DialogService { get; set; } = null!;
    [Inject] public ICoachDataProvider CoachDataProvider { get; set; } = null!;
    [Inject] public IVisitorDataProvider VisitorDataProvider { get; set; } = null!;
    [Inject] public IAddCoachCommand AddCoachCommand { get; set; } = null!;
    [Inject] public IAddAdministratorCommand AddAdministratorCommand { get; set; } = null!;
    [Inject] public IAddVisitorCardCommand AddVisitorCardCommand { get; set; } = null!;
    [Inject] public IAddVisitorCommand AddVisitorCommand { get; set; } = null!;

    private MudTable<Visitor>? visitorsTable = null;
    private MudTable<Coach>? coachesTable = null;
    private string? visitorSearchString = null;
    private string? coachSearchString = null;
    private string infoFormat = "Items {first_item}-{last_item} of {all_items}";
    private ICollection<Visitor>? Visitors = new List<Visitor>();
    private ICollection<Coach>? Coaches = new List<Coach>();
    public string? ErrorMessage { get; set; } = null;


    protected override async Task OnInitializedAsync()
    {
        await GetCoachesAtWorkAsync();
        await GetVisitorsInGymAsync();
        coachesTable = new();
        visitorsTable = new();
    }

    private async Task HandleResetError()
    {
        ErrorMessage = null;
        await GetCoachesAtWorkAsync();
        await GetVisitorsInGymAsync();
        coachesTable = new();
        visitorsTable = new();
        StateHasChanged();
    }

    private async Task GetCoachesAtWorkAsync()
    {
        try
        {
            Coaches = await CoachDataProvider.GetCoachesAtWorkAsync();
            await Task.Delay(100); // for db connection stability
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private async Task GetVisitorsInGymAsync()
    {
        try
        {
            Visitors = await VisitorDataProvider.GetVisitorsInGymAsync();
            await Task.Delay(100); // for db connection stability
        }
        catch (Exception ex)
        {
            ErrorMessage = ex.Message;
        }
    }

    private async Task CoachesReloadAsync(string? sortLabel)
    {
        await GetCoachesAtWorkAsync();
        if (!string.IsNullOrWhiteSpace(coachSearchString))
            Coaches = Coaches?
                .Where(c => $"{c.FirstName} {c.LastName} {c.PhoneNumber} {c.Email}"
                    .Contains(coachSearchString, StringComparison.OrdinalIgnoreCase))
                .ToList();
        switch (sortLabel)
        {
            case "ln_sort":
                Coaches = Coaches.OrderByDirection(SortDirection.Ascending, o => o.LastName).ToList();
                break;
            case "ph_sort":
                Coaches = Coaches.OrderByDirection(SortDirection.Ascending, o => o.PhoneNumber).ToList();
                break;
        }
        // Coaches = Coaches.Skip(state.Page * state.PageSize).Take(state.PageSize).ToList();
        StateHasChanged();
    }

    private async Task VisitorsReloadAsync(string? sortLabel)
    {
        await GetVisitorsInGymAsync();
        if (!string.IsNullOrWhiteSpace(visitorSearchString))
            Visitors = Visitors?
                .Where(v => $"{v.FirstName} {v.LastName} {v.PhoneNumber} {v.Email} {v.VisitorCard?.BarCode}"
                        .Contains(visitorSearchString, StringComparison.OrdinalIgnoreCase))
                .ToList();
        switch (sortLabel)
        {
            case "ln_sort":
                Visitors = Visitors.OrderByDirection(SortDirection.Ascending, o => o.LastName).ToList();
                break;
            case "ph_sort":
                Visitors = Visitors.OrderByDirection(SortDirection.Ascending, o => o.PhoneNumber).ToList();
                break;
        }
        // Visitors = Visitors.Skip(state.Page * state.PageSize).Take(state.PageSize).ToList();
        StateHasChanged();
    }

    private async Task OnVisitorSearch(string text)
    {
        visitorSearchString = text;
        await VisitorsReloadAsync(visitorsTable?.SortLabel);
    }

    private async Task OnCoachSearch(string text)
    {
        coachSearchString = text;
        await CoachesReloadAsync(coachesTable?.SortLabel);
    }

    private async void RegisterNewVisitorClick()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, FullWidth = true, MaxWidth = MaxWidth.Small, CloseButton = true, NoHeader = true };
        var parameters = new DialogParameters();
        parameters.Add("VisitorModel", null);
        var dialog = DialogService.Show<CreateVisitorDialog>("New visitor registration", parameters, options);
        await dialog.Result;
    }

    private async Task CheckVisitorInClick(MouseEventArgs args)
    {
        await OpenVisitorCheckIn();
    }

    private async Task OpenVisitorCheckIn()
    {
        var options = new DialogOptions { 
                FullWidth = true, 
                MaxWidth = MaxWidth.Large,
                CloseButton = true,
                DisableBackdropClick = true,
                Position = DialogPosition.Center,
                CloseOnEscapeKey = true
        };
        var dialog = DialogService.Show<VisitorCheckInDialog>("Checking a visitor in", options);
        await dialog.Result;
        await VisitorsReloadAsync(visitorsTable?.SortLabel);
        await Task.Delay(100); // for db connection stability
    }

    private async Task CheckCoachInClick(MouseEventArgs args)
    {
        await OpenCoachCheckIn();
    }

    private async Task OpenCoachCheckIn()
    { 
        var options = new DialogOptions { 
                FullWidth = true, 
                MaxWidth = MaxWidth.Large,
                CloseButton = true,
                DisableBackdropClick = true,
                Position = DialogPosition.Center,
                CloseOnEscapeKey = true
        };
        var dialog = DialogService.Show<CoachCheckInDialog>("Checking a coach in", options);
        await dialog.Result;
        await CoachesReloadAsync(coachesTable?.SortLabel);
        await Task.Delay(100); // for db connection stability
    }

    private async Task OpenVisitorView(Visitor viewedVisitor)
    {
        var options = new DialogOptions
            {
                FullWidth = true,
                MaxWidth = viewedVisitor.PhotoUrl == null ? MaxWidth.Small : MaxWidth.Medium,
                CloseButton = true,
                DisableBackdropClick = true,
                Position = DialogPosition.Center,
                CloseOnEscapeKey = true,
            };
        var parameters = new DialogParameters();
        parameters.Add("Visitor", viewedVisitor);
        var dialog = DialogService.Show<VisitorViewDialog>("Visitor details", parameters, options);
        await dialog.Result;
    }

    private async Task VisitorRowClickEvent(TableRowClickEventArgs<Visitor> tableRowClickEventArgs)
    {
        await OpenVisitorView(tableRowClickEventArgs.Item);
    }

    private async Task OpenCoachView(Coach viewedCoach)
    {
        var options = new DialogOptions
            {
                FullWidth = true,
                MaxWidth = viewedCoach.PhotoUrl == null ? MaxWidth.Small : MaxWidth.Medium,
                CloseButton = true,
                DisableBackdropClick = true,
                Position = DialogPosition.Center,
                CloseOnEscapeKey = true,
            };
        var parameters = new DialogParameters();
        parameters.Add("coachModel", viewedCoach);
        var dialog = DialogService.Show<CoachViewDialog>("Coach details", parameters, options);
        await dialog.Result;
    }
    
    private async Task CoachRowClickEvent(TableRowClickEventArgs<Coach> tableRowClickEventArgs)
    {
        await OpenCoachView(tableRowClickEventArgs.Item);
    }
    
}
